# 수동으로 빌드 및 배포하기

> .jar 파일을 생성하여 AWS Lightsail 서버에 배포하기



### 1. 인스턴스 생성하기

Linux/Unix 기반의 Amazon Linux 2 이미지를 선택해준다.

![출처: https://linked2ev.github.io/spring/2019/08/14/Spring-3-%EC%BB%A4%EB%84%A5%EC%85%98-%ED%92%80%EC%9D%B4%EB%9E%80/](..\image\instance.PNG)

다음으로 인스턴스 플랜을 선택해준다. 월 요금이 가장 저렴한 플랜을 선택하여 진행하다가 메모리 부족으로 빌드가 되지 않아 메모리 용량이 2GB인 플랜으로 다시 진행하였다. 



### 2. Java, Git 설치

Java와 Git을 Lightsail에 설치해주자.

#### 2.1 Java 11 설치

yum에는 설치 가능한 JDK가 1.8까지만 존재하기 때문에 JDK 11을 설치해주기 위해선 다른 방법을 이용해야한다.

- yum(염으로 발음!)이란 ?

  리눅스 배포판에서 사용하는 프로그램 설치 관리 도구이다. rpm 명령어가 해결하지 못했던 패키지 의존성 문제를 해결한 똑똑한 패키지 관리 툴이라고 한다.

나는 Amazon에서 제공하는 OpenJDK인 Amazon Coretto를 다운받아 JDK 11 버전을 설치해주었다. 

```bash
# aws coreetto 다운로드
sudo curl -L https://corretto.aws/downloads/latest/amazon-corretto-11-x64-linux-jdk.rpm -o jdk11.rpm

# jdk11 설치
sudo yum localinstall jdk11.rpm

# jdk version 선택
sudo /usr/sbin/alternatives --config java

# java 버전 확인
java --version

# 다운받은 설치키트 제거
rm -rf jdk11.rpm
```



#### 2.2 Git 설치

```bash
sudo yum install git
```

설치가 완료되면 아래 명령어로 설치 상태를 확인해본다.

```bash
git --version
```



### 3. 프로젝트 Clone

이제 배포할 프로젝트를 clone 해보자. 먼저 clone할 프로젝트를 저장할 디렉토리를 생성한다.

```bash
mkdir app
mkdir app/git
```

생성된 `git` 디렉토리로 이동한 후 프로젝트를 clone해준다.

```bash
cd ~/app/git
git clone https://github.com/프로젝트주소.git
```



### 4. 배포 스크립트 생성 및 배포

배포를 하기 위해선 프로젝트 clone or pull → test & build → 서버에서 해당 프로젝트 실행 및 재실행 과정을 거쳐야한다. 

이 과정을 배포시마다 직접 해주는것은 불편하기 때문에 쉘 스크립트를 작성하여 차례대로 진행해주자.



 `~/app/git/`에 `deploy.sh` 파일을 하나 생성한다.

```bash
vim ~/app/git/deploy.sh
```

그리고 다음 코드를 추가한다.

```bash
#!/bin/bash

# 프로젝트 디렉토리 주소 변수로 저장
REPOSITORY=/home/ec2-user/app/git

# 프로젝트가 위치한 디렉토리로 이동
cd $REPOSITORY/backend/backend/

echo "> Git Pull"

# main 브랜치의 최신 내용 pull
git pull

echo "> 프로젝트 Build 시작"

# 권한 
chmod +x gradlew

# 프로젝트 내부의 gradlew로 build 수행
./gradlew build

echo "> Build 파일 복사"

# build 결과물인 jar 파일을 복사 및 이동
cp ./build/libs/*.jar $REPOSITORY/

echo "> 현재 구동중인 애플리케이션 pid 확인"

# 기존에 수행중인 스프링부트 어플리케이션이 있다면 종료
CURRENT_PID=$(pgrep -f backend)

echo "$CURRENT_PID"

if [ -z $CURRENT_PID ]; then
    echo "> 현재 구동중인 애플리케이션이 없으므로 종료하지 않습니다."
else
    echo "> kill -2 $CURRENT_PID"
    kill -9 $CURRENT_PID
    sleep 5
fi

echo "> 새 어플리케이션 배포"

# 새로 실행할 jar 파일명을 찾는다
# 여러 jar 파일이 생기기 때문에 tail -n으로 가장 최신의 jar 파일을 변수에 저장
JAR_NAME=$(ls $REPOSITORY/ |grep 'backend' | tail -n 1)

echo "> JAR Name: $JAR_NAME"

# jar 파일 실행
nohup java -jar $REPOSITORY/$JAR_NAME &
```

- gradlew

  Gradle Wrappe는 쉘 스크립트로, wrapper를 통해 Gradle 빌드를 할 수 있다. Gradle 빌드가 시작될 때, Gradle이 자동으로 다운로드 되고 빌드된다. 

  프로젝트에서 Wrapper를 함께 배포함으로써 어떤 환경에서도 Gradle을 설치하지 않고 프로젝트를 빌드할 수 있다. 이를 통해, 빌드를 하는 유저들이 동일한 Gradle 버전의 사용을 보장받는다. 

- nohub

  스프링부트를 이용할 경우 별도의 외장 톰캣을 설치하지 않고 내장된 톰캣으로 어플리케이션을 실행할 수 있다. 

  일반적으로 java를 실행시킬 때 `java -jar`라는 명령어를 사용할 수 있지만, 이렇게 할 경우 사용자가 터미널 접속을 끊을 경우 어플리케이션도 같이 종료된다. 

  `nohub`은 터미널이 종료되어도 어플리케이션은 구동될 수 있도록하는 명령어이다.

 

이제 스크립트를 실행해보자.

```bash
./deploy.sh
```

이때 권한 문제로 실행이 안되면 다음과 같이 해준다.

```bash
chmod +x deploy.sh
```



스크립트가 정상적으로 실행되면 아래 명령어로 실행되는 프로세스를 확인할 수 있다.

```bash
ps -ef|grep backend
```

jar 파일이 잘 실행되고 있다면 외부 서비스로 접근해보자.

기본적으로 스프링부트는 8080 포트로 실행되기 때문에 Lightsail 인스턴스의 8080 포트를 열어줘야한다.



### 5. 문제점

개발자는 배포를 하기 위해 매번 수동으로 스크립트를 실행해야한다.  이러한 과정을 자동화한다면 보다 편리할 것이다. 



### 참고자료

https://jojoldu.tistory.com/263?category=635883

https://pompitzz.github.io/blog/Java/awsEc2InstallJDK11.html#%E1%84%8E%E1%85%A1%E1%86%B7%E1%84%80%E1%85%A9%E1%84%8C%E1%85%A1%E1%84%85%E1%85%AD

