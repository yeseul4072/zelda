## Lightsail(Linux2)에 Nginx로 React + Spring boot 배포하기

### 개요

앞서 Spring boot application을 `.jar` 파일로 빌드하고 배포해보았다. 

이번에는 React를 Nginx 서버에 배포하고 Nginx를 프록시 서버로 만들어 spring boot로 라우팅하는 역할을 할 수 있게끔 해보겠다.

실습 환경은 Aws Lightsail Linux2이다.



### React 배포하기

1. nvm 설치

   nvm(Node Version Manager)은 node.js의 버전을 관리하는 도구이다. nvm을 사용하는 이유는

   - 다양한 버전의 Node.js를 설치할 수 있게 해줌
   - 버전 관리(default 버전 관리, 설치한 버전 리스트 조회 등)가 쉬워짐

   때문이다.

   다음 문서를 참고해서 설치해주었다.

   https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v2/developer-guide/setting-up-node-on-ec2-instance.html

   ```bash
   $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
   ```

   휴톤 프로젝트는 node.js 14.15.5 버전을 사용했기때문에 해당 버전 설치해주었다.

   ```bash
   # nvm 활성화
   $. ~/.nvm/nvm.sh
   # node.js 설치
   $ nvm install 14.15.5
   # 설치된 node 버전 확인
   $ nvm list
   # 디폴트 버전 설정
   $ nvm alias default 14.15.5
   # 버전 확인
   $ nvm -v
   ```

2. Nginx 설치

   Nginx설치가 안돼서 헤매다 Amazon Linux 2에서는 yum을 통핸 Nginx 설치가 지원되지 않는다는 사실을 알게 되었다(https://freedeveloper.tistory.com/340).

   ```bash
   # amaxon-linux-extras list 명령어를 통해 설치할 nginx 찾아보기
   $ amazon-linux-extras list | grep nginx
   38  nginx1=latest            enabled      [ =stable ] 
   
   # nginx 설치
   $ sudo amazon-linux-extras install -y nginx1
   
   # nginx 설치 확인
   $ nginx -v
   ```

   nginx를 사용하기 위한 명령어

   ```bash
   $ sudo service nginx start
   $ sudo service nginx stop
   $ sudo service nginx status
   $ sudo service nginx restart
   ```

3. nginx conf 파일 설정

   nginx 설정 파일 정보

   - `/etc/nginx` : Nginx를 설정하는 디렉토리
   - `/etc/nginx/nginx.conf` : Nginx의 메인 설정 파일로, `sites-enabled` 폴더에 있는 파일들을 include한다.
   - `/etc/nginx/sites-available` : 서버 환경들에 대한 설정 파일들이 위치하는 곳이다.
   - `/etc/nginx/sites-enabled` : `site-available` 디렉토리와 sync된 파일들이 존재하는 곳으로, 이 폴더에 위치한 환경 파일들을 읽어 서버를 세팅한다.

   Nginx 서버 환경을 설정하기 위해 `/etc/nginx/site-availables/` 파일을 수정하여야하는데 나는 이 파일을 찾을 수가 없었다. 

   구글링을 통해 없으면 직접 만들면 된다는 것을 알게되었고 https://gist.github.com/sanrandry/bd4350a591f62eb259e48cd9fbfcd642를 참고하여 `sites-available`, `sites-enabled` 디렉토리와`default` 파일을 만들고 심볼링 링크해주었다.

   

   `/etc/nginx/nginx.conf` 파일에 site-enabled 폴더 내의 모든 파일을 include 한다는 내용을 추가해주고,

   ```
   http {
   	...
   	include /etc/nginx/sites-enabled/*;
   	...
   }
   ```

   `/etc/nginx/sites-available/default` 파일을 다음과 같이 작성해준다.

   ```shell
   # 서버 등록
   server {
   	# 80 포트로 서비스
   	listen 80;
   	# 루트 진입 설정 : http://[ip주소]/로 진입할 때에 대해
   	location / {
   		# react 프로젝트의 build 폴더 경로
   		root /home/ec2-user/app/git/frontend/build;
   		# 해당 폴더에서 redirect할 기본 파일
   		index index.html index.htm;
   		try_files $uri $uri/ /index.html;
   	}
   }
   ```

4. React 빌드

   `/home/ec2-user/app/git` 위치에 react 프로젝트를 git clone 해준 후 빌드해주었다.

   ```bash
   $ cd /home/ec2-user/app/git
   $ git clone [git 주소]
   $ cd frontend
   $ npm install
   $ npm run build
   ```

   `build` 폴더 안에 build된 파일들이 생성된 것을 확인하면 성공이다.

5. nginx 재 시작

   ```bash
   $ sudo service nginx restart
   ```

   재 시작을 하려고 보니 `nginx permission denied error` 에러가 떴다. 

   `/var/log/nginx/error.log` 에서 에러 로그 확인해 본 결과 permission 에러 때문이었고 `/etc/nginx/nginx.conf` 에 `user nginx` 을 `user root` 로 수정하니 문제가 해결됐다.

   

   사이트 url로 접속하면 react가 배포된 것을 확인할 수 있다.



### Spring boot proxy 설정

웹 서버인 Nginx가 하는 역할을 아래 두 가지이다.

- 정적인 리소스 처리

  이미지, css같은 정적인 리소스에 대한 request를 처리한다.

- Reverse Proxy 서버

  서버 중개 대리인(Proxy)으로, 웹 어플리케이션 서버(WAS)로 라우팅하는 역할을 한다.

https://developer88.tistory.com/299

이제 Nginx를 Reverse Proxy 서버로 만들어 배포한 Spring boot 어플리케이션과 연결해주자.

`etc/nginx/sites-available/default` 파일에 아래 내용을 추가한다.

```shell
server {
	...
	location /api {
		proxy_pass http://[ip주소]:8080/api;
	}
	
}
```

- 이제 nginx는 `http://[ip주소]/api`로 진입하는 모든 request를 proxy_pass에 설정한 경로로 할당해 줄 것이다.
- 8080포트를 사용한 이유는 spring boot의 기본 설정 포트가 8080이기 때문이다.

nginx를 재시작해주면 nginx가 spring boot 프로젝트를 프록시하는 것을 확인할 수 있다!



### SSL 적용(HTTPS 설정하기)

추후 추가할 예정!

https://shinjongpark.github.io/2020/02/17/AWS-nginx-vue-spring-ssl.html



### 참고

https://firework-ham.tistory.com/35

https://www.hanumoka.net/2019/12/29/react-20191229-react-nginx-deploy/

https://chloe-codes1.gitbook.io/til/server/deployment/deploying_a_django-vue_application_on_aws_ec2_using_nginx

https://dptablo.tistory.com/235

https://jojoldu.tistory.com/267?category=635883

https://shinjongpark.github.io/2020/02/17/AWS-nginx-vue-spring-ssl.html